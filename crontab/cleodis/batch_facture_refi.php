<?php
define("__BYPASS__",true);
$_SERVER["argv"][1] = "cleodis";
include(dirname(__FILE__)."/../../global.inc.php");
ATF::define("tracabilite",false);

$dataPath = __DATA_PATH__."cleodis/";




$i = "CREATE TABLE IF NOT EXISTS `batch_facture_refi` (
		  `ref` varchar(12) DEFAULT NULL,
		  `date` varchar(10) DEFAULT NULL
		) ENGINE=InnoDB DEFAULT CHARSET=utf8;";

ATF::db()->sql2array($i);


$i2 = "INSERT INTO `batch_facture_refi` (`ref`, `date`) VALUES
					('R', 'Date'),
					('1307013-1-RE', '2014-03-31'),
					('1303010-1-RE', '2014-03-31'),
					('1303028-1-RE', '2014-03-31'),
					('1304004-1-RE', '2014-03-31'),
					('1304006-1-RE', '2014-03-31'),
					('1304008-1-RE', '2014-03-31'),
					('1304021-1-RE', '2014-03-31'),
					('1304002-1-RE', '2014-03-31'),
					('1303006-1-RE', '2014-03-31'),
					('1304003-1-RE', '2014-03-31'),
					('1304015-1-RE', '2014-03-31'),
					('1304018-1-RE', '2014-03-31'),
					('1303008-1-RE', '2014-03-31'),
					('1303015-1-RE', '2014-03-31'),
					('1301005-1-RE', '2014-03-31'),
					('1304031-1-RE', '2014-03-31'),
					('1304033-1-RE', '2014-03-31'),
					('1304011-1-RE', '2014-03-31'),
					('1304058-1-RE', '2014-03-31'),
					('1303027-1-RE', '2014-03-31'),
					('1303025-1-RE', '2014-03-31'),
					('1304063-1-RE', '2014-03-31'),
					('1304054-1-RE', '2014-03-31'),
					('1305005-1-RE', '2014-03-31'),
					('1305004-1-RE', '2014-03-31'),
					('1304034-1-RE', '2014-03-31'),
					('1305008-1-RE', '2014-03-31'),
					('1305009-1-RE', '2014-03-31'),
					('1305010-1-RE', '2014-03-31'),
					('1305014-1-RE', '2014-03-31'),
					('1304013-1-RE', '2014-03-31'),
					('1304016-1-RE', '2014-03-31'),
					('1304017-1-RE', '2014-03-31'),
					('1304014-1-RE', '2014-03-31'),
					('1304060-1-RE', '2014-03-31'),
					('1304057-1-RE', '2014-03-31'),
					('1304065-1-RE', '2014-03-31'),
					('1303011-1-RE', '2014-03-31'),
					('1305016-1-RE', '2014-03-31'),
					('1305018-1-RE', '2014-03-31'),
					('1305025-1-RE', '2014-03-31'),
					('1305006-1-RE', '2014-03-31'),
					('1305028-1-RE', '2014-03-31'),
					('1305017-1-RE', '2014-03-31'),
					('1303032-1-RE', '2014-03-31'),
					('1305030-1-RE', '2014-03-31'),
					('1306001-1-RE', '2014-03-31'),
					('1305021-1-RE', '2014-03-31'),
					('1306008-1-RE', '2014-03-31'),
					('1305029-1-RE', '2014-03-31'),
					('1306041-1-RE', '2014-03-31'),
					('1306044-1-RE', '2014-03-31'),
					('1307001-1-RE', '2014-03-31'),
					('1307008-1-RE', '2014-03-31'),
					('1311003-1-RE', '2014-04-30'),
					('1307016-1-RE', '2014-04-30'),
					('1306038-1-RE', '2014-04-30'),
					('1306034-1-RE', '2014-04-30'),
					('1307023-1-RE', '2014-04-30'),
					('1307005-1-RE', '2014-04-30'),
					('1307031-1-RE', '2014-04-30'),
					('1307015-1-RE', '2014-04-30'),
					('1307053-1-RE', '2014-04-30'),
					('1304066-1-RE', '2014-04-30'),
					('1307081-1-RE', '2014-04-30'),
					('1305024-1-RE', '2014-04-30'),
					('1307050-1-RE', '2014-04-30'),
					('1308030-1-RE', '2014-04-30'),
					('1308022-1-RE', '2014-04-30'),
					('1309014-1-RE', '2014-04-30'),
					('1307036-1-RE', '2014-04-30'),
					('1307009-1-RE', '2014-04-30'),
					('1307011-1-RE', '2014-04-30'),
					('1309048-1-RE', '2014-04-30'),
					('1307059-1-RE', '2014-04-30'),
					('1307047-1-RE', '2014-04-30'),
					('1308031-1-RE', '2014-04-30'),
					('1307006-1-RE', '2014-04-30'),
					('1307051-1-RE', '2014-04-30'),
					('1310010-1-RE', '2014-04-30'),
					('1310011-1-RE', '2014-04-30'),
					('1309096-1-RE', '2014-04-30'),
					('1310062-1-RE', '2014-04-30'),
					('1310068-1-RE', '2014-04-30'),
					('1310073-1-RE', '2014-04-30'),
					('1311006-1-RE', '2014-04-30'),
					('1311011-1-RE', '2014-04-30'),
					('1309097-1-RE', '2014-04-30'),
					('1309025-1-RE', '2014-04-30'),
					('1308029-1-RE', '2014-04-30'),
					('1309054-1-RE', '2014-04-30'),
					('1310049-1-RE', '2014-04-30'),
					('1311014-1-RE', '2014-04-30'),
					('1310009-1-RE', '2014-04-30'),
					('1308032-1-RE', '2014-05-31'),
					('1308008-1-RE', '2014-05-31'),
					('1308028-1-RE', '2014-05-31'),
					('1310034-1-RE', '2014-05-31'),
					('1310006-1-RE', '2014-05-31'),
					('1307048-1-RE', '2014-05-31'),
					('1310043-1-RE', '2014-05-31'),
					('1310023-1-RE', '2014-05-31'),
					('1310058-1-RE', '2014-05-31'),
					('1310082-1-RE', '2014-05-31'),
					('1310074-1-RE', '2014-05-31'),
					('1310008-1-RE', '2014-05-31'),
					('1310031-1-RE', '2014-05-31'),
					('1310033-1-RE', '2014-05-31'),
					('1310032-1-RE', '2014-05-31'),
					('1307071-1-RE', '2014-05-31'),
					('1311038-1-RE', '2014-05-31'),
					('1310012-1-RE', '2014-05-31'),
					('1309018-1-RE', '2014-05-31'),
					('1310028-1-RE', '2014-05-31'),
					('1310014-1-RE', '2014-05-31'),
					('1310015-1-RE', '2014-05-31'),
					('1310057-1-RE', '2014-05-31'),
					('1310071-1-RE', '2014-05-31'),
					('1310072-1-RE', '2014-05-31'),
					('1311008-1-RE', '2014-05-31'),
					('1312045-1-RE', '2014-05-31'),
					('1309013-1-RE', '2014-05-31'),
					('1311023-1-RE', '2014-05-31'),
					('1310069-1-RE', '2014-05-31'),
					('1310016-1-RE', '2014-05-31'),
					('1307007-1-RE', '2014-05-31'),
					('1310021-1-RE', '2014-05-31'),
					('1310019-1-RE', '2014-05-31'),
					('1310013-1-RE', '2014-05-31'),
					('1310059-1-RE', '2014-05-31'),
					('1307063-1-RE', '2014-05-31'),
					('1306018-1-RE', '2014-05-31'),
					('1309030-1-RE', '2014-05-31'),
					('1310018-1-RE', '2014-05-31'),
					('1309015-1-RE', '2014-05-31'),
					('1308025-1-RE', '2014-05-31'),
					('1311031-1-RE', '2014-06-30'),
					('1307075-1-RE', '2014-06-30'),
					('1310053-1-RE', '2014-06-30'),
					('1312005-1-RE', '2014-06-30'),
					('1311042-1-RE', '2014-06-30'),
					('1312034-1-RE', '2014-06-30'),
					('1312042-1-RE', '2014-06-30'),
					('1310024-1-RE', '2014-06-30'),
					('1311024-1-RE', '2014-06-30'),
					('1310050-1-RE', '2014-06-30'),
					('1312043-1-RE', '2014-06-30'),
					('1310052-1-RE', '2014-06-30'),
					('1311018-1-RE', '2014-06-30'),
					('1311025-1-RE', '2014-06-30'),
					('1309029-1-RE', '2014-06-30'),
					('1308018-1-RE', '2014-06-30'),
					('1312041-1-RE', '2014-06-30'),
					('1312039-1-RE', '2014-06-30'),
					('1312046-1-RE', '2014-06-30'),
					('1312040-1-RE', '2014-06-30'),
					('1312044-1-RE', '2014-06-30'),
					('1309055-1-RE', '2014-06-30'),
					('1310026-1-RE', '2014-06-30'),
					('1306016-1-RE', '2014-06-30');";


ATF::db()->sql2array($i2);
















$q = "SELECT * 
	  FROM  `batch_facture_refi`";

$factures = ATF::db()->sql2array($q);	  

foreach ($factures as $key => $value) {
	if($key > 0){
		$facture = $facture_lignes = array();	
		$values_facture["produits"] = array();	

		$q2 = "SELECT * 
			   FROM  `facture`
			   WHERE ref = '".$value["ref"]."'";



		$facture = ATF::db()->sql2array($q2);
		$facture = $facture[0];		

		ATF::facture_ligne()->q->reset()->where("id_facture",$facture["id_facture"]);
		$facture_lignes = ATF::facture_ligne()->select_all();
		switch ($value["date"]) {
			case '2014-03-31':
				$facture["date"] = "2014-04-30";				
			break;
			case '2014-04-30':
				$facture["date"] = "2014-07-31";
			break;
			case '2014-05-31':
				$facture["date"] = "2014-08-31";
			break;
			case '2014-06-30':
				$facture["date"] = "2014-09-30";
			break;
		}
		$facture["date_previsionnelle"] = $facture["date"];
		
		ATF::db()->begin_transaction();
		try{

			$id = $facture["id_facture"];	
		
			unset($facture["id_facture"]);
			
			ATF::facture()->d($id);
					
			foreach ($facture_lignes as $k => $v) {				
				unset($v["id_facture_ligne"],$v["id_facture"]);
				$d = array();
				foreach ($v as $cle => $valeur) {				
					if(strpos($cle,'id') !== false){
						if($cle !==  'id_affaire_provenance'){
							$cle = $cle."_fk";		
						}								
					}				
					$cle = "facture_ligne__dot__".$cle;
					$d[$cle] = $valeur;
				}
				$values_facture["produits"][] = $d;
			}

			$values_facture["produits"] = json_encode($values_facture["produits"]);
			$id = ATF::facture()->insert(array("facture"=>$facture , "values_facture"=> $values_facture));
			
			echo "Mise à jour Facture ref : ".$facture["ref"]."\n";	

		}catch(errorATF $e){
			ATF::db()->rollback_transaction();
		}
		ATF::db()->commit_transaction();
	}
}



$deleteTable = "DROP TABLE batch_facture_refi";
ATF::db()->sql2array($deleteTable);

?>